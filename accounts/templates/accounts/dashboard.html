{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/light-theme.css' %}" id="theme-stylesheet">
</head>
<body>
    <button id="toggle-theme">Toggle Dark Mode</button>
    <h2>Welcome to your Dashboard</h2>
    <a href="{% url 'logout' %}">Logout</a>
    <br>
    <a href="{% url 'delete_account' %}" onclick="return confirm('Are you sure you want to delete your account?');">Delete Account</a>
    <br>
    <a href="{% url 'spotify_login' %}">Login with Spotify</a>
    <br>
    <button id="create-wrapped-btn">Create Wrapped</button>
    <!-- <a href="{% url 'create_wrapped' %}" id="create-wrapped-link">Create Wrapped</button>  -->

    <h2>Your Spotify Wraps</h2>
    {% if user_data_list %}
        <ul>
            {% for data in user_data_list %}
                <li>
                    <h3>{{ data.wrap_name }}</h3>
                    <ul>
                        {% for track in data.top_tracks.items %}
                            <li>{{ track.name }} by {{ track.artists.0.name }}</li>
                        {% endfor %}
                    </ul>
                    <a href="{% url 'wrap_detail' data.id %}">View Wrap Details</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No Spotify wraps saved yet.</p>
    {% endif %}


    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const themeToggleButton = document.getElementById('toggle-theme');
        const themeStylesheet = document.getElementById('theme-stylesheet');

        themeToggleButton.addEventListener('click', () => {
            const currentTheme = themeStylesheet.getAttribute('href');

            if (currentTheme === '{% static "css/light-theme.css" %}') {
                themeStylesheet.setAttribute('href', '{% static "css/dark-theme.css" %}');
            } else {
                themeStylesheet.setAttribute('href', '{% static "css/light-theme.css" %}');
            }
        });

        // const createWrappedButton = document.getElementById("create-wrapped-btn");

        // createWrappedButton.addEventListener("click", async function () {
        //     try {
        //         // Send POST request to the backend
        //         const response = await fetch("{% url 'create_wrapped' %}", {
        //             method: "POST",
        //             headers: {
        //                 "X-CSRFToken": "{{ csrf_token }}", // Include CSRF token for security
        //             },
        //         });

        //         const data = await response.json();

        //         if (response.ok && data.warning) {
        //             // Wrap already exists; confirm if the user wants another
        //             const confirmCreate = confirm(data.warning + " Do you want to create another?");
        //             if (!confirmCreate) return; // User chose not to create a new wrap

        //             // User confirmed, create a new wrap
        //             const responseCreate = await fetch("{% url 'create_wrapped' %}", {
        //                 method: "POST",
        //                 headers: {
        //                     "X-CSRFToken": "{{ csrf_token }}",
        //                 },
        //             });

        //             const newWrap = await responseCreate.json();
        //             if (responseCreate.ok) {
        //                 alert(newWrap.success); // Success message
        //                 location.reload(); // Reload page to show the new wrap
        //             } else {
        //                 alert(newWrap.error); // Error creating wrap
        //             }
        //         } else if (response.ok && data.success) {
        //             // No wraps existed; new wrap created
        //             alert(data.success);
        //             location.reload();
        //         } else {
        //             // General error handling
        //             alert(data.error || "Something went wrong. Please try again.");
        //         }
        //     } catch (err) {
        //         alert("Something went wrong. Please try again.");
        //     }
        // });
        const createWrappedButton = document.getElementById("create-wrapped-btn");

        createWrappedButton.addEventListener("click", async function () {
            try {
                // Initial request to check if a wrap already exists
                const response = await fetch("{% url 'create_wrapped' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                });

                const data = await response.json();

                if (response.ok && data.warning) {
                    // Show confirmation popup
                    const confirmCreate = confirm(data.warning + " Do you want to create another?");
                    if (!confirmCreate) return; // User chose not to create another wrap

                    // User confirmed; send second request with `force=true`
                    const forceResponse = await fetch("{% url 'create_wrapped' %}?force=true", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    });

                    const forceData = await forceResponse.json();
                    if (forceResponse.ok && forceData.success) {
                        alert(forceData.success); // Success message
                        location.reload();       // Reload page to display new wrap
                    } else {
                        alert(forceData.error || "Failed to create a new wrap.");
                    }
                } else if (response.ok && data.success) {
                    // Wrap created successfully without warning
                    alert(data.success);
                    location.reload();
                } else {
                    // General error handling
                    alert(data.error || "Something went wrong. Please try again.");
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        });

    });
    </script>
</body>
</html>